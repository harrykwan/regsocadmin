<!-- <html>
<head>
</head>
<body>
	<script src="https://apis.google.com/js/api.js"></script>
	<script>
	function start() {
	  // 2. Initialize the JavaScript client library.
	  gapi.client.init({
	    'apiKey': 'AIzaSyCgqyzrRe2dLa676z725MRVHYhkdQ86A30',
	    // Your API key will be automatically added to the Discovery Document URLs.
	    'discoveryDocs': ['https://people.googleapis.com/$discovery/rest'],
	    // clientId and scope are optional if auth is not required.
	    'clientId': '531417626263-6breo4rq95npc1c9t9ip9cjud10oggdp.apps.googleusercontent.com',
	    'scope': 'https://www.googleapis.com/auth/spreadsheets',
	  }).then(function() {
	    // 3. Initialize and make the API request.
	    return gapi.client.people.people.get({
	      'resourceName': 'people/me',
	      'requestMask.includeField': 'person.names'
	    });
	  }).then(function(response) {
	    console.log(response.result);
	  }, function(reason) {
	    console.log('Error: ' + reason.result.error.message);
	  });
	};
	// 1. Load the JavaScript client library.
	gapi.load('client', start);
	</script>
</body>
</html> -->
<html>
  <head>

    <meta charset="utf-8">
    <style type="text/css">
      table{
        margin-top: 10px;
      }
      td{
        border: 1px solid black;
        padding: 2px;
      }
      tr{

      }

      button{
        padding: 5px;
        margin-right: 10px;
        border-radius: 0;
        border: 1px solid black;
      }

      .myinput{
        padding: 5px;
        margin-right: 10px;
        border-radius: 0;
        border: 1px solid black;
        background-color: white;
      }

      .forma{
          border: 1px solid white;
          border-radius: 3px;
          background: white;
          color: black;
          /*padding: 1px;*/
          width: 100%;
          font-size: 15px;
          font-family: ‘cwTeXYen’,'Noto Sans Tc',/*'FontAwesome', sans-serif;*/'Roboto', sans-serif;
      }

      .mytd{
        border: 1px solid grey;
      }

      .myheader{
        /*border-bottom: 4px solid darkred;*/
        margin-bottom: 20px;
        /*padding: 10px;*/
      }


.navbar {
  overflow: hidden;
  background-color: #333; 
  background-color: #FFF;
  border: 1px solid grey;
}

.navbar a {
  float: left;
  font-size: 16px;
  color: white;
  color: black;
  text-align: center;
  padding: 14px 20px;
  text-decoration: none;
}

.subnav {
  float: left;
  overflow: hidden;
}

.subnav .subnavbtn {
  font-size: 16px;  
  border: none;
  outline: none;
  color: white;
  color: black;
  padding: 14px 20px;
  background-color: inherit;
  font-family: inherit;
  margin: 0;
}

.navbar a:hover, .subnav:hover .subnavbtn {
  background-color: red;
  background-color: #EEE;
  border-bottom: 2px solid #EEE;
}

.subnav-content {
  display: none;
  position: absolute;
  left: 0;
  background-color: red;
  background-color: #EEE;
  width: 100%;
  z-index: 1;
}

.subnav-content a {
  float: left;
  color: white;
  color: black;
  text-decoration: none;
}

.subnav-content a:hover {
  background-color: #FFF;
  color: black;
}

.subnav:hover .subnav-content {
  display: block;
}

  .myselected{
    border-bottom: 2px solid black;
  }

  .mypage{
    border: 1px solid grey;
    padding: 10px;
    margin-bottom: 20px;
    background-color: #FFF;
  }


  .approvebox{
    position: fixed;
    top: 5%;
    left: 0;
    right: 0;
    margin-left: auto;
    margin-right: auto;
    width: 60%;
    background-color: white;
    color: black;
    height: 70%;
    padding: 20px;
    opacity: 0.9;
    border: 1px solid black;
    overflow: scroll;
  }



  #oldmessage>div{
    margin-left: 20px; 
    border-left: 2px solid red; 
    padding-left: 10px;
    margin-bottom: 5px;
  }

    </style>
  </head>
  <body>
    <script type="text/javascript" src="https://js.live.net/v7.2/OneDrive.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-app.js"></script>
     <script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.5/firebase-firestore.js"></script>

    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyBI7Ji3XUH1AaASHAST2j6aj7YUuzKB-R0",
        authDomain: "cuhk-reg-soc.firebaseapp.com",
        databaseURL: "https://cuhk-reg-soc.firebaseio.com",
        projectId: "cuhk-reg-soc",
        storageBucket: "cuhk-reg-soc.appspot.com",
        messagingSenderId: "351403710743"
      };
      firebase.initializeApp(config);
      var db = firebase.firestore();

        // Disable deprecated features
        db.settings({
          timestampsInSnapshots: true
        });
    </script>

    <div id="googleformarea" hidden>
        <iframe id="i_frame" name="googleform"></iframe>

        <form id="form" action="https://docs.google.com/forms/d/e/1FAIpQLSdCOpwSr3UsqSJ9ky4j7NKTFTzCmLxXzzAiQNHaKSv6YgY7Cw/formResponse" target="googleform" method="POST" onsubmit="checkdone(0)">
            <input id="googleforminput1" type="text" name="entry.2045469385" value="">
            <input id="googleforminput2" type="text" name="entry.1431600269" value="">
            <input id="googleforminput3" type="text" name="entry.1528364708" value="">
        </form>
        
    </div>

    <div hidden id="formaarea" style="position: fixed; left: 0; right: 0; margin-left: auto; margin-right: auto; width: 80%; top: 100px; height: 70%; background: white; color: black; opacity: 0.9; padding:20px; overflow: hidden; border: 1px solid black; font-size: 16px;">
        <div style="overflow: scroll; height: 110%; width: 110%;">
            <div style="margin-top: 50px; background-color: white; color: black; border: none;">表格A</div>
            <table id="forma" style=" width: 80%;margin-left: 10%; margin-top: 3%; color: black;">
            <tr><td>屬下團體名稱: </td><td><input disabled class="forma" type="text" name=""></td></tr>
            <tr><td>團體性質:</td><td><select disabled class="forma">
              <option value="國際生學生會">國際生學生會</option>
              <option value="院/系會">院/系會</option>
              <option value="學會/認可會社">學會/認可會社</option>
            </select></td></tr>
            <tr><td>幹事會(或同等行政機構)任期</td><td><input disabled class="forma" type="text" name=""></td></tr>
            <tr><td>是否為臨時行政機構</td><td><select disabled class="forma">
              <option value="是臨時行政機構">是</option>
              <option value="不是臨時行政機構">否</option>
            </select></td></tr>
            <tr><td>是否設有代表會(或同等監察機構)</td><td><select disabled class="forma">
              <option value="是設有代表會">是</option>
              <option value="不是設有代表會">否</option>
            </select></td></tr>
            <tr><td>代表會(或同等監察機構)任期 </td><td><input disabled class="forma" type="text" name=""></td></tr>
            <tr><td>聯絡人姓名:</td><td><input disabled class="forma" type="text" name=""></td></tr>
            <tr><td>聯絡電話:</td><td><input disabled class="forma" type="text" name=""></td></tr>
            <tr><td>聯絡電郵:</td><td><input disabled class="forma" type="text" name=""></td></tr>
            </table>
            <hr>
           幹事會成員
            <table id="membertable" style=" width: 80%;margin-left: 10%; margin-top: 3%; border: none; color: black;">
                <tr style="border-bottom: 1px solid grey;"><td>職位</td><td>中文名稱</td><td>英文名稱</td><td>學生證編號</td><td>書院</td><td>學系</td><td>學年</td><td>電話</td></tr>
            </table>
            <hr>
           代表會成員
            <table id="membertable2" style=" width: 80%;margin-left: 10%; margin-top: 3%; border: none; color: black;">
                <tr style="border-bottom: 1px solid grey;"><td>職位</td><td>中文名稱</td><td>英文名稱</td><td>學生證編號</td><td>書院</td><td>學系</td><td>學年</td><td>電話</td></tr>
            </table>
             
            
            <div onclick="closeforma()" style="position: fixed; color: black; top:110px; right:10%;">X</div>
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

        </div>

    </div>


    <div hidden id="approvebox" class="approvebox">
      
      <div style="margin-left: 20px; font-size: 18px; font-weight: bold; margin-top: 30px;">Comments</div>
      <input placeholder="your name" id='messageheader' style="font-size: 16px; padding: 5px; border: 1px solid black; width: 80%; margin: 20px; margin-bottom: 10px;" type="text" name=""><br>
      <textarea placeholder="your message" id='messagebody' style="font-size: 16px; padding: 5px; border: 1px solid black; height: 400px; width: 80%; margin: 20px; margin-top: 0px; margin-bottom: 0px;"></textarea><br>
      <button onclick="addcomment()" style="font-size: 16px; padding: 5px; border: 1px solid black; width: 80%; margin: 20px; margin-top: 10px;">Add</button>
      <div style="" id="oldmessage"></div>
      <div onclick="closeapprovebox()" style="position: fixed; color: black; top:6%; right:20%; ">X</div>

    </div>
    <!--
    BEFORE RUNNING:
    ---------------
    1. If not already done, enable the Google Sheets API
       and check the quota for your project at
       https://console.developers.google.com/apis/api/sheets
    2. Get access keys for your application. See
       https://developers.google.com/api-client-library/javascript/start/start-js#get-access-keys-for-your-application
    3. For additional information on authentication, see
       https://developers.google.com/sheets/api/quickstart/js#step_2_set_up_the_sample
    -->
    <script type="text/javascript">
        var loopcheck, loopcheck2;
        var senddone = 1, firstin = 0;
        function checkdone(x) {
            // alert('hi');
            
            loopcheck = setInterval(function(){
                var tempframe = document.getElementById("i_frame");
                senddone = 1;
                firstin = 1;
                // console.log(senddone);
                // console.log(tempframe.contentDocument);
                // console.log(tempframe.contentWindow.location.href);
                if (tempframe.contentDocument){
                    senddone = 0;
                }
            },200);
            loopcheck2 = setInterval(function(){
                if (firstin&&senddone){
                    clearInterval(loopcheck);
                    clearInterval(loopcheck2);
                    var tempframe = document.getElementById("i_frame");
                    // tempframe.src = "";
                    if (x==1)
                      alert('ok');

                        //showok();

                    tempframe.src = "";
                    location.reload();
                }
            },200);
        }
    </script>

    <script>

    var myresult;

    var mydata={};
    var adminlist={};

    function makeApiCall() {
      var params = {
        // The ID of the spreadsheet to retrieve data from.
        spreadsheetId: '1lFp_6UHi4KgSx2vtMw9i39ax-KXojMKqhNTEEywNc7E',//'1DyjIJd6b5hXbNOGTmdTZTMwVc0GPqrlVkx-YKsoc41g',  // TODO: Update placeholder value.

        // The A1 notation of the values to retrieve.
        range: 'A1:Z10000',//'A1:Z1000',  // TODO: Update placeholder value.

        // How values should be represented in the output.
        // The default render option is ValueRenderOption.FORMATTED_VALUE.
        valueRenderOption: 'FORMATTED_VALUE',  // TODO: Update placeholder value.

        // How dates, times, and durations should be represented in the output.
        // This is ignored if value_render_option is
        // FORMATTED_VALUE.
        // The default dateTime render option is [DateTimeRenderOption.SERIAL_NUMBER].
        dateTimeRenderOption: 'SERIAL_NUMBER',  // TODO: Update placeholder value.
      };

      var request = gapi.client.sheets.spreadsheets.values.get(params);
      request.then(function(response) {
        // TODO: Change code below to process the `response` object:
        console.log(response.result);
        myresult = response.result;
        document.getElementById("myshowsheet").innerHTML = '';
        for (var j=1; j<myresult.values.length; j++){
        	// document.getElementById("myshowsheet").innerHTML += myresult.values[j]+'<br>';
          // console.log(myresult.values[j]);
          if (myresult.values[j]){
            if (myresult.values[j][1]){
                if (myresult.values[j][1].split('|').length==2){
                  if (mydata[myresult.values[j][1]]&&mydata[myresult.values[j][1]].finish)
                    delete mydata[myresult.values[j][1]]['finish'];
                  if (!mydata[myresult.values[j][1].split('|')[0]]){
                    mydata[myresult.values[j][1].split('|')[0]] = {};
                  }
                  mydata[myresult.values[j][1].split('|')[0]].step = myresult.values[j][1].split('|')[1];
                  mydata[myresult.values[j][1].split('|')[0]].updatetime =  myresult.values[j][0];
                  // document.getElementById("myshowsheet").innerHTML += myresult.values[j][1].split('|')[0]+' '+myresult.values[j][1].split('|')[1]+'<br>';

                  // for (var k=0; k<myresult.values[j][2].split('|').length; k++){
                  //   if (myresult.values[j][2].split('|')[k]!=''&&myresult.values[j][2].split('|')[k]!='undefined')
                  //    document.getElementById("myshowsheet").innerHTML += '- '+myresult.values[j][2].split('|')[k]+'<br>';
                  // }
                  // document.getElementById("myshowsheet").innerHTML += myresult.values[j][2].split('|')+'<br>';
                  // document.getElementById("myshowsheet").innerHTML += '<br>';
                } else if (myresult.values[j][1].split('|').length==3){
                  if (!mydata[myresult.values[j][1].split('|')[0]]){
                    mydata[myresult.values[j][1].split('|')[0]] = {};
                  }
                   mydata[myresult.values[j][1].split('|')[0]][myresult.values[j][1].split('|')[1]+myresult.values[j][1].split('|')[2]] = myresult.values[j][2];
                    mydata[myresult.values[j][1].split('|')[0]].updatetime =  myresult.values[j][0];         
                } else if (myresult.values[j][1].split('|').length==1){
                  if (myresult.values[j][2]=='comment'){
                    mydata[myresult.values[j][1]].comment = myresult.values[j][3];
                    var tempadmin = myresult.values[j][3].split('<div>');
                    tempadmin = tempadmin[tempadmin.length-1];
                    tempadmin = tempadmin.substring(0,tempadmin.indexOf(':'));
                    // console.log(tempadmin);
                    if (tempadmin){
                      adminlist[tempadmin] = 1;
                    } else {
                      adminlist[tempadmin]++;
                    }
                  } else {
                    if (myresult.values[j][2]=='approve'){
                      if (mydata[myresult.values[j][1]].step=='step2')
                        mydata[myresult.values[j][1]].finish = 1;
                    }
                    clearmydatafile(myresult.values[j][1]);
                    mydata[myresult.values[j][1]].step = undefined;
                    mydata[myresult.values[j][1]].comment = '';
                  }
                }
                // console.log(mydata);
            }
          }
          

        }

        function clearmydatafile(x){
          for (var j=1; j<=11; j++){
            if (mydata[x]['step1form'+j]&&j!=1)
              delete mydata[x]['step1form'+j];
            if (mydata[x]['step2form'+j])
              delete mydata[x]['step2form'+j];
          }
        }



        console.log(mydata);
        var orderlist = [];
        for (var item in mydata){
          orderlist[orderlist.length] = item;
        }

        // console.log(orderlist)

        for (var j=0; j<orderlist.length-1; j++){
          for (var k=j+1; k<orderlist.length; k++){
            if (comparetime(mydata[orderlist[j]].updatetime,mydata[orderlist[k]].updatetime)){
              var temp = orderlist[j];
              orderlist[j] = orderlist[k];
              orderlist[k] = temp;
            }
          }
        }

        // console.log(orderlist);
        
        // for (var item in mydata){
        for (var jj=0; jj<orderlist.length; jj++){
          var item = orderlist[jj];
          var mystep = mydata[item].step;
          if (mystep==undefined)
            mystep = '/';
          else{
             mystep = mystep[4];
            document.getElementById("myshowsheet").innerHTML +=  item + '<table id="'+item+'" style="width: 80%;">'+'<tr><td style="width: 30%;">submit step</td><td>'+ mystep +'</td</tr>'+'<tr><td>last update</td><td>'+mydata[item].updatetime+'</td</tr>'+'</table><br>';
            document.getElementById("myshowsheet").innerHTML += "<button onclick='myapprove("+'"'+item+'",'+mystep+")'>Approve</button>"+"<button onclick='mydisapprove("+'"'+item+'",'+mystep+")'>Fail</button>"+"<button onclick='mycomment("+'"'+item+'"'+")'>Comment</button>"+'<br><br><hr><br><br>';

            var table = document.getElementById(item);
            var myformlist=[];
            if (mystep==1){
              myformlist[1] = '表格A 基本資料';
              myformlist[2] = '表格B 選舉報告';
              myformlist[3] = '表格D 聲明';
              myformlist[4] = '會員名單＊ 或 學系人數證明';
              myformlist[5] = '銀行賬戶確認聲明';
              myformlist[6] = '團體的銀行賬戶結餘證明 或 團體的現金結餘證明'; 
              myformlist[7] = '選票樣式';
              myformlist[8] = '去屆工作報告';
              myformlist[9] = '去屆財政報告';
              myformlist[10] = '現屆工作計劃';
              myformlist[11] = '現屆財政預算';
              myformlist[12] = '其他文件';
            }
            if (mystep==2){
              myformlist[1] = '表格C1 會議表決紀錄 或 表格C2 全民投票紀錄';
              myformlist[2] = '去屆工作報告';
              myformlist[3] = '去屆財政報告';
              myformlist[4] = '現屆工作計劃';
              myformlist[5] = '現屆財政預算';
              myformlist[6] = '其他文件'; 
            }
            for (var j=1; j<=12; j++){
              if (mydata[item]['step'+mystep+'form'+j]){
                var row = table.insertRow(table.rows.length);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var mylink = mydata[item]['step'+mystep+'form'+j].split('|')[1];
                var myfilename = mydata[item]['step'+mystep+'form'+j].split('|')[0];
                cell1.innerHTML = myformlist[j];//'step'+mystep+'form'+j;
                if (mystep==1&&j==1){
                  cell2.innerHTML = '<a href="#forma" onclick="fillforma('+"'"+item+"'"+')">Open</a>'
                } else {
                  cell2.innerHTML = '<a href="#'+myfilename+'" onclick="mydownload('+"'"+mylink+"'"+')">'+myfilename+'</a>';
                }
                
              }
            }

          }
        }

        var tempadminlist = []
        for (j in adminlist){
          tempadminlist.push(j);
        }

        for (var j=0; j<tempadminlist.length-1; j++){
          for (var k=j+1; k<tempadminlist.length; k++){
            if (adminlist[tempadminlist[k]]<adminlist[tempadminlist[j]]){
              var temp = tempadminlist[k];
              tempadminlist[k] = tempadminlist[j];
              tempadminlist[j] = temp;
            }
          }
        }

        var tempouput = '<div style="width:80%;margin-top:10px; font-weight:bold; text-align:center; font-size:25px;">REG SOC RANKING TABLE</div><table style="margin-bottom:50px; margin-top:10px; width: 80%;"><tr style="text-align: center; color:white; background:#555;"><td>NAME</td><td>SCORE</td></tr>';
        for (var j=0; j<tempadminlist.length; j++){
          tempouput += '<tr style="text-align: center;"><td>'+tempadminlist[j]+'</td><td>'+adminlist[tempadminlist[j]]+'</td></tr>';
        }
        document.getElementById('myranktable').innerHTML = tempouput;
        

        document.getElementById("socpaperinput4").value = getnowdate();
        
        if (getCookie('letterman')){
          document.getElementById("socpaperinput3").value = getCookie('letterman');
        }

        for (var j in mydata){
          if (mydata[j].finish){
            var option = document.createElement("option");
            option.text = j;
            document.getElementById("socpaperinput1").add(option);
          }

        }
        socpapersocchange();




      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }


    function socpapersocchange(){
      document.getElementById("socpaperinput2").value = mydata[document.getElementById("socpaperinput1").value].step1form1.split('|')[1].split('-')[1];
    }

    function initClient() {
      var API_KEY = 'AIzaSyCgqyzrRe2dLa676z725MRVHYhkdQ86A30';  // TODO: Update placeholder with desired API key.

      var CLIENT_ID = '531417626263-6breo4rq95npc1c9t9ip9cjud10oggdp.apps.googleusercontent.com';  // TODO: Update placeholder with desired client ID.

      // TODO: Authorize using one of the following scopes:
      //   'https://www.googleapis.com/auth/drive'
      //   'https://www.googleapis.com/auth/drive.file'
      //   'https://www.googleapis.com/auth/spreadsheets'
      var SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

      gapi.client.init({
        'apiKey': API_KEY,
        'clientId': CLIENT_ID,
        'scope': SCOPE,
        'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      }).then(function() {
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
        updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      });
    }

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function updateSignInStatus(isSignedIn) {
      if (isSignedIn) {
        document.getElementById("signin-button").hidden = true;
        document.getElementById("signout-button").hidden = false;
        makeApiCall();
        document.getElementById("myheaderbar").getElementsByTagName('a')[0].click();
      } else {
        document.getElementById("signin-button").hidden = false;
        document.getElementById("signout-button").hidden = true;
      }
    }

    function handleSignInClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    function handleSignOutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    function closeforma(){
        document.getElementById("formaarea").hidden = true;
    }

    function closeapprovebox(){
        document.getElementById("approvebox").hidden = true;
    }

    function setCookie(cname, cvalue, exdays) {
      var d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      var expires = "expires="+d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
      var name = cname + "=";
      var ca = document.cookie.split(';');
      for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }


    function mydownload(x){
      console.log(x);
      var storageRef = firebase.storage().ref();
      var starsRef = storageRef.child(x);

      // Get the download URL
      starsRef.getDownloadURL().then(function(url) {
        // Insert url into an <img> tag to "download"
        console.log(url);
        window.open(url);
      }).catch(function(error) {

        // A full list of error codes is available at
        // https://firebase.google.com/docs/storage/web/handle-errors
        switch (error.code) {
          case 'storage/object-not-found':
            // File doesn't exist
            break;

          case 'storage/unauthorized':
            // User doesn't have permission to access the object
            break;

          case 'storage/canceled':
            // User canceled the upload
            break;

          

          case 'storage/unknown':
            // Unknown error occurred, inspect the server response
            break;
        }
      });
    }

    function comparetime(x,y) {
      return Date.parse(x) > Date.parse(y);
    }

    function changestatus(x,y){
        var docRef = db.collection("societystatus").doc(x);
        docRef.set({
            filelist: '',
            status: y
        })
        .then(function(){
            
        })
        .catch(function(error){
            console.log(error);
        });
    }

    function myapprove(x,y) {
      if (confirm('Approve '+x+'?')){
        if (y==1){
          changestatus(x,2);
        } else if (y==2){
          changestatus(x,4);
        }
        
        document.getElementById("googleforminput2").value = x;
        document.getElementById("googleforminput3").value = "approve";
        document.getElementById("googleforminput1").value = '';
        document.getElementById("form").submit();
        checkdone(1);
      }
      
    }

    var mymessage = '';
    function mydisapprove(x,y) {
      mymessage = prompt("Disapprove reason:",'');
      if (confirm('Disapprove '+x+' for '+mymessage+'?')){
        setusermessage(x,mymessage);
        if (y==1){
          changestatus(x,0);
        } else if (y==2){
          changestatus(x,2);
        }
        document.getElementById("googleforminput2").value = x;
        document.getElementById("googleforminput3").value = "disapprove";
        document.getElementById("googleforminput1").value = mymessage;
        document.getElementById("form").submit();
        checkdone(1);
      }
      
    }

    function setusermessage(x,y){
      var docRef = db.collection("societystatus").doc(x);
      docRef.set({
        failmessage: y
      }, {merge: true});
    }

    function mycomment(x){
      document.getElementById("googleforminput2").value = x;
      // document.getElementById("googleforminput3").value = "comment";
      // document.getElementById("googleforminput1").value = mymessage;
      document.getElementById("approvebox").hidden = false;
      if (mydata[x].comment)
        document.getElementById('oldmessage').innerHTML = mydata[x].comment;
      else
        document.getElementById('oldmessage').innerHTML = '';
    }

    function addcomment(){
      if (confirm('Add comment by '+document.getElementById('messageheader').value+': '+document.getElementById('messagebody').value)){
          document.getElementById("googleforminput3").value = "comment";
          if (mydata[document.getElementById("googleforminput2").value].comment)
            document.getElementById("googleforminput1").value = mydata[document.getElementById("googleforminput2").value].comment+'<div>'+document.getElementById('messageheader').value+': '+document.getElementById('messagebody').value+'</div>';
          else
            document.getElementById("googleforminput1").value = '<div>'+document.getElementById('messageheader').value+': '+document.getElementById('messagebody').value+'</div>';
          document.getElementById('oldmessage').innerHTML = document.getElementById("googleforminput1").value;
          mydata[document.getElementById("googleforminput2").value].comment = document.getElementById('oldmessage').innerHTML;
          document.getElementById("form").submit();
      }
      
    }

    var formadata;
    function fillforma(x) {
      formadata = mydata[x].step1form1.split('|');
      document.getElementById("formaarea").hidden = false;
      for (var j=0; j<=5; j++){
        document.getElementById("forma").getElementsByTagName("input")[j].value = formadata[j];
      }
      
      for (var j=6; j<=8; j++){
        document.getElementById("forma").getElementsByTagName("select")[j-6].value = formadata[j];
      }

      var table = document.getElementById("membertable");

      while (table.rows.length>1){
          table.deleteRow(table.rows.length-1);
      }

      var nowid = -1;
      for (var j=9; j<formadata.length; j+=9){
          if (nowid==-1||formadata[nowid][7]<formadata[j][7]){
            var row = table.insertRow(table.rows.length);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var cell5 = row.insertCell(4);
            var cell6 = row.insertCell(5);
            var cell7 = row.insertCell(6);
            var cell8 = row.insertCell(7);
            cell1.innerHTML = formadata[j+1];
            cell2.innerHTML = formadata[j+2];
            cell3.innerHTML = formadata[j+3];
            cell4.innerHTML = formadata[j+4];
            cell5.innerHTML = formadata[j+5];
            cell6.innerHTML = formadata[j+6];
            cell7.innerHTML = formadata[j+7];
            cell8.innerHTML = formadata[j+8];
            nowid = j;
            cell1.classList.add('mytd');
            cell2.classList.add('mytd');
            cell3.classList.add('mytd');
            cell4.classList.add('mytd');
            cell5.classList.add('mytd');
            cell6.classList.add('mytd');
            cell7.classList.add('mytd');
            cell8.classList.add('mytd');
          } else {
            break;
          }
      }

      var table = document.getElementById("membertable2");

      while (table.rows.length>1){
          table.deleteRow(table.rows.length-1);
      }

      for (var j=nowid+9; j<formadata.length-1; j+=9){
          
            var row = table.insertRow(table.rows.length);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var cell5 = row.insertCell(4);
            var cell6 = row.insertCell(5);
            var cell7 = row.insertCell(6);
            var cell8 = row.insertCell(7);
            cell1.innerHTML = formadata[j+1];
            cell2.innerHTML = formadata[j+2];
            cell3.innerHTML = formadata[j+3];
            cell4.innerHTML = formadata[j+4];
            cell5.innerHTML = formadata[j+5];
            cell6.innerHTML = formadata[j+6];
            cell7.innerHTML = formadata[j+7];
            cell8.innerHTML = formadata[j+8];
            cell1.classList.add('mytd');
            cell2.classList.add('mytd');
            cell3.classList.add('mytd');
            cell4.classList.add('mytd');
            cell5.classList.add('mytd');
            cell6.classList.add('mytd');
            cell7.classList.add('mytd');
            cell8.classList.add('mytd');
      }

    }

    function changepage(x){
      var myheaderbar = document.getElementById("myheaderbar").getElementsByTagName("a");
      for (var j=0; j<myheaderbar.length; j++){
        myheaderbar[j].classList.remove('myselected');
      }
      x.classList.add('myselected');
      var temppages = ["myshowsheet","myranktable","myfilepage","rawdatapage","superuserpage","socpaperpage"];
      for (var j=0; j<temppages.length; j++){
        document.getElementById(temppages[j]).hidden = true;
      }
      if (x.href.split("#")[1]=='home'){
        document.getElementById("myshowsheet").hidden = false;
      } else if (x.href.split("#")[1]=='ranking'){
        document.getElementById("myranktable").hidden = false;
      } else if (x.href.split("#")[1]=='file'){
        document.getElementById("myfilepage").hidden = false;
      } else if (x.href.split("#")[1]=='raw'){
        document.getElementById("rawdatapage").hidden = false;
      } else if (x.href.split("#")[1]=='sudo'){
        document.getElementById("superuserpage").hidden = false;
      } else if (x.href.split("#")[1]=='socpaper'){
        document.getElementById("socpaperpage").hidden = false;
      }
    }

    handleSignInClick();

    var is_date = function(input) {
      if ( Object.prototype.toString.call(input) === "[object Date]" ) 
        return true;
      return false;   
    };

    function getnowdate(){
      var today = new Date();
      var dd = today.getDate();
      var mm = today.getMonth()+1; //January is 0!
      var yyyy = today.getFullYear();

      if(dd<10) {
          dd = '0'+dd
      } 

      if(mm<10) {
          mm = '0'+mm
      } 

      today = mm + '/' + dd + '/' + yyyy;
      return today;
      // document.write(today);
    }

    

    function generateregsocpaper(x,diudate,letterman,letterdate,mymemberlist) {
      console.log(mymemberlist)
        document.getElementById("mainframe").innerHTML = '';
        mymemberlist = mymemberlist.split('|');
        var chinnum = ['零','一','二','三','四','五','六','七','八','九','十'];

        if (!letterdate)
          letterdate = getnowdate();

        if (letterman){
          letterman = '<br>（'+letterman+'代行）';
        }

        document.getElementById("mainframe").innerHTML += '<div id="socshit"><div style="background-color: white; color black;  overflow: hidden;"><img style="width: 100%;" src="regsocpaper.png"></div>    <div style="background-color: white; color: black; text-align: center; padding: 20px;">        <h1 style="font-size: 18px;">香港中文大學學生會<br>屬下團體登記證明書</h1>      <br>根據《屬下團體章則》第三十三條發出<br><br><br><br>        <div style="width: 700px; text-align: left; margin: 0 auto;">茲證明「'+x+'」已按照《屬下團體章則》第31條之規定完成週年登記，有效期至'+diudate+'止。            <br><br>            以下為上述團體在週年登記時提供的幹事資料:        </div>        <br><br><br> <table style="border-collapse: collapse; margin: 0 auto; width: 70%;" id="memberlisttable"><tr style="height: 20px;"><td style="border: 1px solid black;">職位</td><td style="border: 1px solid black;">中文姓名</td><td style="border: 1px solid black; ">英文姓名</td><td style="border: 1px solid black;">學生編號</td></tr></table>          <br><br>  <div style="width: 700px; text-align: left; margin: 0 auto;">如有任何查詢，請以電郵 cuhkrc.acsc@gmail.com 聯絡本委員會。</div><br><br><br><br>  <div style="width: 700px; text-align: right; margin: 0 auto;">香港中文大學學生會代表會<br>屬下團體委員會主席'+letterman+'</div><div style="width: 700px; text-align: left; margin: 0 auto;">'+letterdate+'</div><br><br><br><br></div></div>';
        //+chinnum[(n+'')[0]]+chinnum[(n+'')[1]]+chinnum[(n+'')[2]]+chinnum[(n+'')[3]]+'年一月三十一日
        // var mymemberlist = doc.data().memberlist.split('|');
        var table = document.getElementById("memberlisttable");
        
        for (var j=0; j<(mymemberlist.length-1)/5; j++){
            var row = table.insertRow(table.rows.length);
            row.style.height = "20px";
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            cell1.innerHTML = mymemberlist[j*5+1];
            cell2.innerHTML = mymemberlist[j*5+2];
            cell3.innerHTML = mymemberlist[j*5+3];
            cell4.innerHTML = mymemberlist[j*5+4];
            cell1.style.border = '1px solid black';
            cell2.style.border = '1px solid black';
            cell3.style.border = '1px solid black';
            cell4.style.border = '1px solid black';
            cell1.style.padding = '2px';
            cell2.style.padding = '2px';
            cell3.style.padding = '2px';
            cell4.style.padding = '2px';

        }

        document.getElementById("socshit").onclick = function(){
            PrintElem(document.getElementById("socshit"));
        }

        // PrintElem(document.getElementById("socshit"));



        // var mywindow = window.open("regsocpaper.html", "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,top=1000,left=1000,width=1000,height=1000");

    }


    var mywindow;
    function PrintElem(elem){
        mywindow = window.open('', 'PRINT', 'height=1600,width=1000');

        mywindow.document.body.innerHTML = "";
        mywindow.document.write('<html><head><title>' +  '</title>');
        mywindow.document.write('</head><body>');
        mywindow.document.write(elem.innerHTML);
        mywindow.document.write('</body></html>');

        // mywindow.document.close(); // necessary for IE >= 10
        // mywindow.focus(); // necessary for IE >= 10*/


            // mywindow.print();
        // mywindow.close();

        return true;
    }


    function genpaper(){
      var tempinput1 = document.getElementById("socpaperinput1").value;
      var tempinput2 = document.getElementById("socpaperinput2").value;
      var tempinput3 = document.getElementById("socpaperinput3").value;
      var tempinput4 = document.getElementById("socpaperinput4").value;
      var tempinput5 = mydata[tempinput1].step1form1;
      tempinput5 = tempinput5.substring(tempinput5.indexOf('student1'));
      tempinput5 = tempinput5.split('|');
      console.log(tempinput5)
      var tempoutputtable = '';
      for (var j=0; j<tempinput5.length; j+=9){
        if (j!=0&&tempinput5[j]=='student1'||tempinput5[j]=='')
          break;
        tempoutputtable+=tempinput5[j]+'|';
        tempoutputtable+=tempinput5[j+1]+'|';
        tempoutputtable+=tempinput5[j+2]+'|';
        tempoutputtable+=tempinput5[j+3]+'|';
        tempoutputtable+=tempinput5[j+4]+'|';
      }
      console.log(tempoutputtable)

      setCookie('letterman',tempinput3,300);

      generateregsocpaper(tempinput1,tempinput2,tempinput3,tempinput4,tempoutputtable);
      //(x,diudate,letterman,letterdate,mymemberlist)
    }



    </script>
    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    <div id="myheader" class="myheader">
      <div id="myheaderbar" class="navbar">
        <a onclick="changepage(this)" class='myselected' href="#home">Home</a>
        <a onclick="changepage(this)" href="#ranking">Regsoc Ranking</a>
        <a onclick="changepage(this)" href="#file">File</a>
        <a onclick="changepage(this)" href="#raw">Raw Data</a>
        <a onclick="changepage(this)" href="#sudo">Super User</a>
        <a onclick="changepage(this)" href="#socpaper">Gen Soc Paper</a>
  <!-- <div class="subnav">
    <button class="subnavbtn">About <i class="fa fa-caret-down"></i></button>
  </div>  -->
  <!-- <div class="subnav">
    <button class="subnavbtn">Partners <i class="fa fa-caret-down"></i></button>
    <div class="subnav-content">
      <a href="#link1">Link 1</a>
      <a href="#link2">Link 2</a>
    </div>
  </div> -->
      </div>
    </div>
    <div hidden class="mypage" id="myshowsheet"></div>
    <div hidden class="mypage" id="myranktable">
      

    </div>
    <div hidden class="mypage" id="myfilepage">
      <a target="_blank" href="https://console.firebase.google.com/project/cuhk-reg-soc/storage/cuhk-reg-soc.appspot.com/files">click here</a>
      <!-- <iframe style="width: 100%; height: 90%;" src="https://console.firebase.google.com/project/cuhk-reg-soc/storage/cuhk-reg-soc.appspot.com/files"></iframe> -->

    </div>
    <div hidden class="mypage" id="rawdatapage">
      <iframe style="width: 100%; height: 100%;" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRkralVI-D4JJGEXhEqy8PgsvHg_pwaFzPohr5bq_MMXlGawI_cXJd9DASmUfJHj9BUsMEmKJIJ51xD/pubhtml?widget=true&amp;headers=false"></iframe>
    </div>

    <div hidden class="mypage" id="superuserpage">
      
    </div>

    <div hidden class="mypage" id="socpaperpage">
      <select class="myinput" id="socpaperinput1" onchange="socpapersocchange()">
      </select>
      <input class="myinput" hidden id="socpaperinput2" type="" name="">
      <input class="myinput" id="socpaperinput3" type="" name="">
      <input class="myinput"id="socpaperinput4" type="" name="">
      <button onclick="genpaper()">Generate</button>
      <hr>
      <div id="mainframe" style="height:1600px; width:1000px;"></div>
    </div>

    <button hidden id="signin-button" onclick="handleSignInClick()">Sign in</button>
    <button hidden id="signout-button" onclick="handleSignOutClick()">Sign out</button>
  </body>
</html>
